<div class="container">

  <h1 class="text-center">To Do List</h1>

  <div class="panel panel-info">
    <div class="panel-heading">
      <h3 class="panel-title">事項清單</h3>
    </div>

    <!-- Add new todo -->
    <div class="panel-body">
      <form>
        <label>Add new to-do</label>
        <div class="input-group">
          <input type="text_area" id="new-todo" class="form-control" />
          <div class="input-group-addon">
            <button id="create-todo" class="my-btn my-btn-transparent">Create</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Todo List -->
    <table class="my-table table table-hover">
      <tbody id="todolist">
        <% @todos.each do |todo| %>
          <tr id="<%= todo.id %>">
            <%= render :partial => "todo", :locals => { :todo => todo } %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
  /*我們必須把事件驅動設定在一個更高層的 element，讓這個 element 去定位下層 element 
    會觸發的事件驅動，這個技巧叫 event targeting。

    當我們點擊 todolist 裡的任一網頁元件時，它都會向 todolist 發出事件，但因為我們設定了這個 todolist 的事件驅動，而它只監聽來自於 .delete-todo 的網頁元件，因此只有在點擊 .delete-todo時才會觸發該事件驅動，發送非同步的 DELETE 請求。
  */
  $("#todolist").on("click", ".delete-todo", function(event) {
    //  由於被點擊的刪除按鈕在 <tr> 標籤下的 <td> 裡，
    //  因此在觸發事件驅動時， 必須從 event.target 往上走兩層才能找到對應該 todo 的 id。
    var id = event.target.parentNode.parentNode.id;
    console.log(id);   
    $.ajax({
      url: "todos/" + id,
      method: "DELETE",
      dataType: "json",
      success: function(data) {
        $("#" + data["id"]).remove();
      }
    });
  });

  // 如果 form 裡沒有設定 action，Chrome 瀏覽器就會把 form action 預設成當前網址。
  $("#create-todo").on("click", function(event) {
    event.preventDefault();
    $.ajax({
      url: "todos/",
      method: "POST",
      dataType: "json",
      data: { 
        todo: { 
          title: $("#new-todo").val()
        }
      },

      success: function(data) {
        var todo = document.createElement("tr");
        todo.id = data["id"];
      }
    });
  });

</script>

<script type="text/template" id="todo-template">
  <td class="my-pointer">
    <span class="my-font glyphicon glyphicon-unchecked"></span>
  </td>
  <td>
    <p class="title my-font"></p>
  </td>
  <td class="my-operation">
    <span class="my-btn my-btn-transparent text-info glyphicon glyphicon-pencil"></span>
    <span class="delete-todo my-btn my-btn-transparent text-danger glyphicon glyphicon-trash"></span>
  </td>
</script>